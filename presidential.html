<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Presidential Election Model (2000-2024)</title>

  <!-- D3 + TopoJSON -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  
  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    html{ color-scheme: light; }

    :root{
      /* Palette */
      --bg-app: #f3f4f6;
      --bg-gradient-1: #eef2ff;
      --bg-gradient-2: #fff1f2;
      
      --ink: #111827;
      --ink-dim: #374151;
      --muted: #6b7280;
      --muted-light: #9ca3af;

      --card-bg: rgba(255, 255, 255, 0.85);
      --card-border: rgba(255, 255, 255, 0.6);
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);

      --line: #e5e7eb;
      --line-strong: #d1d5db;

      /* Political Colors (Modern Standard) */
      --blue: #2563eb;
      --blue-dark: #1e40af;
      --blue-soft: #dbeafe;
      --blue-border: #93c5fd;

      --red: #dc2626;
      --red-dark: #991b1b;
      --red-soft: #fee2e2;
      --red-border: #fca5a5;

      --neutral-bg: #f9fafb;
      --neutral-border: #e5e7eb;

      /* UI */
      --focus-ring: 0 0 0 3px rgba(99, 102, 241, 0.3);
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --radius-pill: 9999px;

      --sans: 'Inter', system-ui, -apple-system, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;

      /* Semantic */
      --ok: #10b981;
      --warn: #f59e0b;
      --zero: #1f2937;
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background-color: var(--bg-app);
      background-image:
        radial-gradient(circle at 10% 10%, var(--bg-gradient-1), transparent 40%),
        radial-gradient(circle at 90% 20%, var(--bg-gradient-2), transparent 40%);
      background-attachment: fixed;
      overflow-x:hidden;
      -webkit-font-smoothing: antialiased;
    }

    .wrap{
      max-width:1280px;
      margin:0 auto;
      padding:24px;
    }

    /* App Bar */
    .appbar{
      position:sticky;
      top:0;
      z-index:60;
      padding:16px 0 20px;
      background: linear-gradient(to bottom, var(--bg-app) 0%, rgba(243,244,246,0.8) 60%, transparent 100%);
      pointer-events: none;
    }
    .appbarInner{
      pointer-events: auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding:12px 16px;
      border-radius:var(--radius-lg);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border:1px solid var(--card-border);
      box-shadow: var(--card-shadow);
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:250px;
    }
    .brandMark{
      width:40px;height:40px;
      border-radius:12px;
      background: linear-gradient(135deg, var(--red), var(--blue));
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
      position: relative;
      overflow: hidden;
    }
    .brandMark::after {
      content: "";
      position: absolute;
      top: 0; right: 0; bottom: 0; left: 50%;
      background: rgba(255,255,255,0.15);
      transform: skewX(-15deg) translateX(5px);
    }
    
    .brandTitle{
      display:flex;
      flex-direction:column;
      line-height:1.1;
    }
    .brandTitle .t{
      font-size:16px;
      font-weight:800;
      letter-spacing:-0.01em;
      color: var(--ink);
    }
    .brandTitle .s{
      font-size:13px;
      color:var(--muted);
      font-weight:500;
    }

    /* Segmented Control */
    .seg{
      position:relative;
      display:flex;
      background: var(--neutral-bg);
      border:1px solid var(--line);
      border-radius:var(--radius-pill);
      padding:4px;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.03);
      min-width:420px;
      justify-content:space-between;
    }
    .seg button{
      position:relative;
      appearance:none;
      border:none;
      background:transparent;
      color:var(--muted);
      font-weight:600;
      font-size:13px;
      padding:8px 12px;
      border-radius:var(--radius-pill);
      cursor:pointer;
      flex:1;
      text-align:center;
      transition: color .2s ease;
      z-index: 2;
    }
    .seg button:hover { color: var(--ink-dim); }
    .seg button.active{ color: var(--blue-dark); text-shadow: 0 0 1px rgba(0,0,0,0.1); }
    .segIndicator{
      position:absolute;
      top:4px; bottom:4px;
      width:calc(14.285% - 4px);
      border-radius:var(--radius-pill);
      background: #ffffff;
      border:1px solid rgba(0,0,0,0.04);
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      transform: translateX(0%);
      transition: transform .25s cubic-bezier(0.2, 0.8, 0.2, 1);
      z-index: 1;
      pointer-events:none;
    }
    .seg[data-year="2000"] .segIndicator{ transform: translateX(0%); }
    .seg[data-year="2004"] .segIndicator{ transform: translateX(100%); }
    .seg[data-year="2008"] .segIndicator{ transform: translateX(200%); }
    .seg[data-year="2012"] .segIndicator{ transform: translateX(300%); }
    .seg[data-year="2016"] .segIndicator{ transform: translateX(400%); }
    .seg[data-year="2020"] .segIndicator{ transform: translateX(500%); }
    .seg[data-year="2024"] .segIndicator{ transform: translateX(600%); }

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns: 1fr;
      gap:24px;
      margin-top:0px;
    }

    /* Cards */
    .card{
      border:1px solid var(--card-border);
      border-radius:var(--radius-lg);
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: var(--card-shadow);
      overflow:hidden;
      transition: box-shadow 0.2s ease;
    }
    .card:hover {
      box-shadow: var(--card-shadow-hover);
    }
    
    .cardTitleRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:16px 20px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(to bottom, rgba(255,255,255,0.5), rgba(255,255,255,0));
    }

    .cardTitle{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .cardTitle .h{
      font-size:15px;
      font-weight:700;
      color: var(--ink);
    }
    .cardTitle .sub{
      font-size:13px;
      color:var(--muted);
      font-weight:500;
    }
    .cardInner{ padding:20px; }

    /* Seat meter */
    .seatAxis{
      position:relative;
      height:72px;
      border-radius:var(--radius-md);
      border:1px solid var(--line);
      background: var(--neutral-bg);
      overflow:hidden;
    }
    #seatTicks{ position:absolute; inset:0; pointer-events:none;}
    .seatBar{
      position:absolute;
      left:16px; right:16px;
      top:26px;
      height:16px;
      border-radius:8px;
      background: rgba(0,0,0,0.05);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      overflow:hidden;
      display:flex;
    }
    .seatSeg{ height:100%; transition: width .4s cubic-bezier(0.2, 0.8, 0.2, 1); }
    
    .seatD{ background: linear-gradient(180deg, var(--blue) 0%, var(--blue-dark) 100%); }
    .seatR{ background: linear-gradient(180deg, var(--red) 0%, var(--red-dark) 100%); }
    .seatO{ background: transparent; }

    .seatMajorityLine{
      position:absolute;
      top:0; bottom:0;
      width:2px;
      background: var(--ink);
      z-index: 5;
      opacity: 0.8;
      pointer-events: none;
    }
    .seatMajorityLine::after {
        content: '';
        position: absolute;
        top: 0; left: -2px; right: -2px; height: 6px;
        background: var(--ink);
    }
    
    .seatTickLabel{
      position:absolute;
      bottom:8px;
      transform:translateX(-50%);
      font-size:11px;
      font-weight:600;
      color: var(--muted);
      font-family: var(--mono);
      user-select:none;
    }
    .seatTickLine{
      position:absolute;
      top:0; bottom:0;
      width:1px;
      background: var(--line-strong);
      opacity: 0.5;
    }

    /* Map */
    .mapStage{
      position: relative;
      background: white; 
      border-radius: var(--radius-md);
      box-shadow: inset 0 0 20px rgba(0,0,0,0.03);
    }
    .mapSvg{
      width:100%;
      height:600px;
      overflow: visible;
      display:block;
    }

    .state{
      stroke: white;
      stroke-width: 1px;
      vector-effect: non-scaling-stroke;
      cursor:default;
      transition: fill 0.2s ease, filter 0.2s ease;
    }
    .state.active{ cursor:pointer; }
    .state.hovered{
      stroke: var(--ink);
      stroke-width:2px;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
      z-index: 10;
      position: relative; 
    }

    .legendOverlay{
      position:absolute;
      left:20px;
      bottom:20px;
      padding:12px;
      border-radius:var(--radius-md);
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(8px);
      border:1px solid var(--line);
      box-shadow: var(--card-shadow);
    }
    .swatch{
      width:180px;
      height:14px;
      border-radius:99px;
      border:1px solid rgba(0,0,0,0.05);
      background: linear-gradient(90deg,
        var(--blue-dark) 0%,
        var(--blue) 35%,
        #fde047 50%,
        var(--red) 65%,
        var(--red-dark) 100%);
    }

    /* Tooltip */
    #tip{
      position:fixed;
      left:0; top:0;
      transform: translate(-9999px,-9999px);
      pointer-events:none;
      width: min(320px, calc(100vw - 28px));
      z-index:100;
      border-radius:var(--radius-lg);
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(16px);
      border:1px solid rgba(0,0,0,0.08);
      box-shadow: 0 20px 40px -5px rgba(0,0,0,0.15), 0 10px 20px -5px rgba(0,0,0,0.1);
      overflow:hidden;
      font-family: var(--sans);
    }
    .tipTop{
      padding:12px;
      border-bottom:1px solid var(--line);
      background: var(--neutral-bg);
    }
    .tipHeader{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .tipTitle{ margin:0; font-size:15px; font-weight:800; line-height:1.2; color: var(--ink); }
    .tipMeta{
      text-align:right;
      font-size:11px;
      color:var(--muted);
      font-weight:600;
      font-family: var(--mono);
    }
    .tipSub{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:6px;
      border:1px solid var(--line);
      background: white;
      font-variant-numeric: tabular-nums;
      font-size:12px;
      font-weight:600;
      color: var(--ink-dim);
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }
    .dot{ width:8px;height:8px;border-radius:50%; background: var(--muted-light); }
    .dot.blue{ background: var(--blue); }
    .dot.red{ background: var(--red); }

    .tipBody{
      display:block;
      padding:10px 12px 12px;
    }

    /* Ultra-compact "model factors" rows inside tooltip */
    .miniRow{
      display:flex;
      align-items:center;
      gap:10px;
      margin:7px 0;
    }
    .miniLbl{
      width:96px;
      font-size:10px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:0.06em;
      color: var(--muted);
    }
    .miniVal{
      width:58px;
      text-align:right;
      font-family: var(--mono);
      font-size:11px;
      font-weight:800;
      color: var(--ink);
      font-variant-numeric: tabular-nums;
    }
    .miniBar{
      position:relative;
      flex:1;
      height:8px;
      border-radius:9999px;
      background: var(--neutral-bg);
      border:1px solid var(--line);
      overflow:hidden;
    }
    .miniZero{
      position:absolute;
      left:50%;
      top:0;
      bottom:0;
      width:1px;
      background: rgba(31,41,55,0.35);
    }
    .miniFill{
      position:absolute;
      top:0; bottom:0;
      border-radius:9999px;
      opacity:0.9;
    }
    .miniFill.blue{ background: var(--blue-soft); }
    .miniFill.red{ background: var(--red-soft); }

    /* Bucket table */
    .bucketTableWrap{
      overflow-x: auto;
      margin:0 -20px;
      padding:0 20px;
    }
    .bucketTable{
      border-collapse:separate;
      border-spacing:6px 6px;
      width: 100%;
      min-width: 560px;
      background: var(--neutral-bg);
      padding: 8px;
    }
    .bucketTable th{
      text-align:left;
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
      font-weight: 700;
      padding:8px 12px;
      background: transparent;
      border-bottom: 2px solid var(--line);
      position:sticky;
      top:0;
      z-index:2;
    }
    .bucketTable td{ vertical-align:top; padding:0; }
    
    .raceItem{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:4px;
      border-radius:8px;
      padding:10px 12px;
      border:1px solid var(--line);
      background: #fff;
      text-align:left;
      cursor:pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
      transition: all 0.15s ease;
      margin-bottom: 6px;
      position: relative;
      overflow: hidden;
    }
    .raceItem:hover{
      transform:translateY(-2px);
      box-shadow: 0 8px 16px -4px rgba(0,0,0,0.1);
      border-color: var(--line-strong);
    }
    
    .raceItem::before {
        content: "";
        position: absolute;
        left: 0; top: 0; bottom: 0; width: 4px;
    }
    .raceItem.d::before{ background: var(--blue); }
    .raceItem.r::before{ background: var(--red); }
    .raceItem.t::before{ background: var(--muted-light); }

    .raceTop { 
        font-size: 11px; 
        font-weight: 700; 
        color: var(--muted); 
        text-transform: uppercase; 
        letter-spacing: 0.05em; 
    }
    .raceName {
        font-size: 14px;
        font-weight: 700;
        color: var(--ink);
    }
    .raceBottom {
        font-family: var(--mono);
        font-size: 12px;
        color: var(--ink-dim);
        font-weight: 600;
        margin-top: 2px;
    }

    .raceEmpty{
      height:44px;
      border-radius:8px;
      border:1px dashed var(--line-strong);
      background:rgba(0,0,0,0.01);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted-light);
      font-size: 12px;
      font-weight: 500;
    }

    /* Error Handling */
    .loadError{
      margin: 10px 0 16px;
      padding: 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--red-border);
      background: var(--red-soft);
      color: var(--red-dark);
      box-shadow: var(--card-shadow);
      font-weight: 600;
      line-height: 1.4;
      font-size: 14px;
    }
    .loadError .mono{ font-family: var(--mono); background: rgba(255,255,255,0.5); padding: 2px 4px; border-radius: 4px; }

    /* Map Interaction */
    .state.focus{ 
        stroke: var(--ink); 
        stroke-width:2.5px; 
        z-index: 20; 
    }
    
    /* Utilities */
    .tiny{ font-size:12px; color:var(--muted); }

/* Panel header */
.topCard{ padding:18px 20px; }
.panelHeaderRow{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:16px;
  flex-wrap: wrap;
}
.panelTitleWrap{ display:flex; flex-direction:column; }
.panelTitle{
  font-size:22px;
  font-weight:900;
  letter-spacing:-0.02em;
  color: var(--ink);
  line-height:1.05;
}
.panelSub{
  font-size:14px;
  font-weight:600;
  color: var(--muted);
  margin-top:6px;
}
.pillRow{ display:flex; align-items:center; gap:10px; flex-wrap: wrap; }
.metricPill{
  display:flex;
  align-items:center;
  gap:10px;
  padding:8px 14px;
  border-radius: var(--radius-pill);
  background: rgba(255,255,255,0.9);
  border:1px solid rgba(229,231,235,0.9);
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
  font-weight:800;
  font-size:14px;
  color: var(--ink);
  font-variant-numeric: tabular-nums;
  user-select:none;
  min-width: 84px;
  justify-content:center;
}
.metricPill .dot{
  width:10px; height:10px;
  border-radius:9999px;
  flex:0 0 auto;
}
.metricPill.blue .dot{ background: var(--blue); }
.metricPill.red  .dot{ background: var(--red); }

.seatsCard{ padding:0; }
.seatsSummary{
  min-height: 120px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:22px 18px 18px;
  background: rgba(255,255,255,0.65);
}
.seatsLine{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:24px;
  font-weight:900;
  font-size:20px;
  letter-spacing:0.01em;
  font-variant-numeric: tabular-nums;
}
.seatsSide{
  display:flex;
  align-items:baseline;
  gap:10px;
  font-family: var(--mono);
}
.seatsSide .lbl{ font-size:14px; font-weight:900; }
.seatsSide .num{ font-size:20px; font-weight:900; }
.seatsSide.d{ color: var(--blue); }
.seatsSide.r{ color: var(--red); }
.seatsDivider{ width:1px; height:34px; background: rgba(209,213,219,0.9); }

/* tiny simulation histogram */
.simMini{
  width: min(360px, 100%);
  margin-top: 14px;
  margin-left:auto;
  margin-right:auto;
}
.simCanvas{
  width: 100%;
  height: 26px;
  display:block;
}

.simTip{
  position:fixed;
  z-index:90;
  pointer-events:none;
  background: rgba(17,24,39,0.92);
  color:#fff;
  padding:6px 8px;
  border-radius:10px;
  font-size:11px;
  font-weight:700;
  font-family: var(--mono);
  line-height:1.25;
  box-shadow: 0 10px 24px rgba(0,0,0,0.18);
  transform: translate(-9999px,-9999px);
  white-space: nowrap;
}
.simTip .k{ font-weight:900; opacity:0.95; }

.mapCard{ position:relative; }
.mapHint{
  padding: 0 20px 16px;
  margin-top:-8px;
  font-size:12px;
  font-weight:600;
  color: var(--muted);
}

/* Winner badge */
.winnerBadge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 700;
  margin-left: 12px;
}
.winnerBadge.d { background: var(--blue-soft); color: var(--blue-dark); }
.winnerBadge.r { background: var(--red-soft); color: var(--red-dark); }

/* Actual result badge in tooltip */
.actualRow {
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid var(--line);
}
.actualLabel {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--muted);
  margin-bottom: 4px;
}
.actualValue {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 700;
}
.actualValue.d { color: var(--blue); }
.actualValue.r { color: var(--red); }

  </style>
</head>

<body>
  <div class="wrap">
    <div class="appbar">
      <div class="appbarInner">
        <div class="brand">
          <div class="brandMark" aria-hidden="true"></div>
          <div class="brandTitle">
            <span class="t">Presidential Election Model</span>
            <span class="s">Hindcast 2000–2024</span>
          </div>
        </div>
        <nav class="seg" data-year="2024" aria-label="Select election year">
          <button type="button" data-val="2000">2000</button>
          <button type="button" data-val="2004">2004</button>
          <button type="button" data-val="2008">2008</button>
          <button type="button" data-val="2012">2012</button>
          <button type="button" data-val="2016">2016</button>
          <button type="button" data-val="2020">2020</button>
          <button type="button" data-val="2024" class="active">2024</button>
          <div class="segIndicator" aria-hidden="true"></div>
        </nav>
      </div>
    </div>

    <div id="loadError" class="loadError" hidden></div>

    <div class="layout">
      <!-- Header Card -->
      <section class="card topCard">
        <div class="panelHeaderRow">
          <div class="panelTitleWrap">
            <div class="panelTitle" id="electionTitle">2024 Presidential Election</div>
            <div class="panelSub" id="candidateNames">Kamala Harris (D) vs Donald Trump (R)</div>
          </div>
          <div class="pillRow" aria-label="National polling average">
            <div class="metricPill blue" aria-label="Dem polling">
              <span class="dot" aria-hidden="true"></span>
              <span class="val" id="nationalD">48.7</span>
            </div>
            <div class="metricPill red" aria-label="GOP polling">
              <span class="dot" aria-hidden="true"></span>
              <span class="val" id="nationalR">48.6</span>
            </div>
            <span id="actualWinner"></span>
          </div>
        </div>
      </section>

      <!-- Electoral Votes Card -->
      <section class="card seatsCard" aria-label="Projected electoral votes">
        <div class="seatsSummary">
          <div class="seatsLine">
            <div class="seatsSide d"><span class="lbl">D</span><span class="num" id="evD">—</span></div>
            <div class="seatsDivider" aria-hidden="true"></div>
            <div class="seatsSide r"><span class="lbl">R</span><span class="num" id="evR">—</span></div>
          </div>
          <div class="simMini" aria-label="Electoral vote simulation distribution">
            <canvas class="simCanvas" id="simCanvas"></canvas>
          </div>
        </div>
      </section>

      <!-- Map Card -->
      <section class="card mapCard" aria-label="Map">
        <div class="cardInner">
          <div class="mapStage">
            <svg class="mapSvg" id="mapSvg" aria-label="US map"></svg>
            <div class="legendOverlay" aria-hidden="true">
              <div class="swatch"></div>
            </div>
          </div>
        </div>
        <div class="mapHint">Hover a state for details.</div>
      </section>

      <!-- Competitive States Table -->
      <section class="card">
        <div class="cardTitleRow">
          <div class="cardTitle">
            <span class="h">Competitive States</span>
            <span class="sub">Margins within ±12.5 points</span>
          </div>
        </div>
        <div class="cardInner">
          <div class="bucketTableWrap">
            <table class="bucketTable" aria-label="Competitive states by rating">
              <thead>
                <tr>
                  <th>Likely D</th>
                  <th>Lean D</th>
                  <th>Tossup</th>
                  <th>Lean R</th>
                  <th>Likely R</th>
                </tr>
              </thead>
              <tbody id="bucketBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Tooltip -->
  <div id="tip">
    <div class="tipTop">
      <div class="tipHeader">
        <h3 class="tipTitle" id="tipTitle">State</h3>
        <div class="tipMeta" id="tipMeta">0 EV</div>
      </div>
      <div class="tipSub" id="tipSub"></div>
    </div>
    <div class="tipBody" id="tipBody"></div>
  </div>

  <!-- Simulation tooltip -->
  <div class="simTip" id="simTip"></div>

<script>
/* ---------- Configuration ---------- */
const YEARS = [2000, 2004, 2008, 2012, 2016, 2020, 2024];
const PROB_ERROR_SD_PTS = 4.5;
const WEIGHTS = { gb: 35, polls: 50, ind: 15 };
const VIS = { show: 12.5, likely: 7.5, lean: 2.5 };
const MC_SIMS = 10000;

/* ---------- Electoral votes by state ---------- */
const EV_BY_STATE = {
  AL:9, AK:3, AZ:11, AR:6, CA:54, CO:10, CT:7, DE:3, DC:3, FL:30,
  GA:16, HI:4, ID:4, IL:19, IN:11, IA:6, KS:6, KY:8, LA:8, ME:4,
  MD:10, MA:11, MI:15, MN:10, MS:6, MO:10, MT:4, NE:5, NV:6, NH:4,
  NJ:14, NM:5, NY:28, NC:16, ND:3, OH:17, OK:7, OR:8, PA:19, RI:4,
  SC:9, SD:3, TN:11, TX:40, UT:6, VT:3, VA:13, WA:12, WV:4, WI:10, WY:3
};

/* State names */
const USPS_TO_NAME = {
  AL:"Alabama",AK:"Alaska",AZ:"Arizona",AR:"Arkansas",CA:"California",CO:"Colorado",CT:"Connecticut",DE:"Delaware",DC:"District of Columbia",
  FL:"Florida",GA:"Georgia",HI:"Hawaii",ID:"Idaho",IL:"Illinois",IN:"Indiana",IA:"Iowa",KS:"Kansas",KY:"Kentucky",LA:"Louisiana",ME:"Maine",
  MD:"Maryland",MA:"Massachusetts",MI:"Michigan",MN:"Minnesota",MS:"Mississippi",MO:"Missouri",MT:"Montana",NE:"Nebraska",NV:"Nevada",NH:"New Hampshire",
  NJ:"New Jersey",NM:"New Mexico",NY:"New York",NC:"North Carolina",ND:"North Dakota",OH:"Ohio",OK:"Oklahoma",OR:"Oregon",PA:"Pennsylvania",RI:"Rhode Island",
  SC:"South Carolina",SD:"South Dakota",TN:"Tennessee",TX:"Texas",UT:"Utah",VT:"Vermont",VA:"Virginia",WA:"Washington",WV:"West Virginia",WI:"Wisconsin",WY:"Wyoming"
};

const NAME_TO_USPS = {};
for (const [usps, name] of Object.entries(USPS_TO_NAME)) {
  NAME_TO_USPS[name] = usps;
}

const FIPS_TO_USPS = {
  1:"AL",2:"AK",4:"AZ",5:"AR",6:"CA",8:"CO",9:"CT",10:"DE",11:"DC",12:"FL",13:"GA",15:"HI",16:"ID",17:"IL",18:"IN",19:"IA",20:"KS",21:"KY",22:"LA",23:"ME",24:"MD",25:"MA",26:"MI",27:"MN",28:"MS",29:"MO",30:"MT",31:"NE",32:"NV",33:"NH",34:"NJ",35:"NM",36:"NY",37:"NC",38:"ND",39:"OH",40:"OK",41:"OR",42:"PA",44:"RI",45:"SC",46:"SD",47:"TN",48:"TX",49:"UT",50:"VT",51:"VA",53:"WA",54:"WV",55:"WI",56:"WY"
};

function fipsToUsps(id){ const n = parseInt(id, 10); return FIPS_TO_USPS[n] || ""; }

/* ---------- Data storage ---------- */
const DATA = {
  national: {},  // year -> {D, R, winner, demCandidate, gopCandidate}
  ratios: {},    // year -> state -> {D, R}
  polls: {},     // year -> state -> margin (D - R)
  actuals: {}    // year -> state -> margin (D - R)
};

let currentYear = 2024;
let MAP = null;

/* ---------- Math helpers ---------- */
const clamp = (x,a,b) => Math.max(a, Math.min(b, x));

function normalizePair(D, R){
  const d = Number(D), r = Number(R);
  const s = d + r;
  if (!isFinite(s) || s <= 0) return {D:50, R:50};
  return {D: 100*d/s, R: 100*r/s};
}

function marginRD(pair){ return pair.R - pair.D; }

function fmtLead(m){
  if (!isFinite(m)) return "—";
  if (Math.abs(m) < 0.05) return "Tied";
  const pts = Math.abs(m).toFixed(1);
  return (m < 0) ? `D+${pts}` : `R+${pts}`;
}

function erf(x){
  const sign = x < 0 ? -1 : 1;
  x = Math.abs(x);
  const a1=0.254829592,a2=-0.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=0.3275911;
  const t = 1/(1+p*x);
  const y = 1 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*Math.exp(-x*x);
  return sign*y;
}

function normalCDF(x){ return 0.5*(1 + erf(x/Math.SQRT2)); }

function winProbFromMargin(m){
  const z = m / PROB_ERROR_SD_PTS;
  const pR = clamp(normalCDF(z), 0, 1);
  return { pD: 1 - pR, pR };
}

/* Fast win-prob lookup */
const WINP_MIN = -40, WINP_MAX = 40, WINP_STEP = 0.1;
const WINP_N = Math.round((WINP_MAX - WINP_MIN) / WINP_STEP) + 1;
const WINP_PD_TABLE = new Float32Array(WINP_N);
for (let i=0;i<WINP_N;i++){
  const m = WINP_MIN + i*WINP_STEP;
  WINP_PD_TABLE[i] = winProbFromMargin(m).pD;
}

function winProbD_fast(m){
  if (!isFinite(m)) return 0.5;
  const mm = clamp(m, WINP_MIN, WINP_MAX);
  const idx = Math.round((mm - WINP_MIN) / WINP_STEP);
  return WINP_PD_TABLE[idx] ?? 0.5;
}

/* ---------- Color ---------- */
function interpColor(m){
  if (!isFinite(m)) return "#e5e7eb";
  const max = 25;
  const a = Math.abs(m);
  if (a < 2.0) return "rgb(253,224,71)";
  const t = clamp(a/max, 0, 1);
  if (m < 0){
    const r = Math.round(248*(1-t) + 37*t);
    const g = Math.round(250*(1-t) + 99*t);
    const b = Math.round(252*(1-t) + 235*t);
    return `rgb(${r},${g},${b})`;
  } else {
    const r = Math.round(252*(1-t) + 220*t);
    const g = Math.round(250*(1-t) + 38*t);
    const b = Math.round(250*(1-t) + 38*t);
    return `rgb(${r},${g},${b})`;
  }
}

function bucketKeyFromMargin(m){
  if (!isFinite(m)) return null;
  const a = Math.abs(m);
  const side = (m < 0) ? "D" : "R";
  if (a >= VIS.show) return null;
  if (a <= VIS.lean) return "Tossup";
  if (a <= VIS.likely) return `Lean ${side}`;
  return `Likely ${side}`;
}

/* ---------- Data loading ---------- */
async function loadData(){
  const errBox = document.getElementById("loadError");
  
  try {
    // Load national polls
    const nationalCSV = `Year,Dem_Candidate,GOP_Candidate,Dem_Poll_Avg,GOP_Poll_Avg,Poll_Margin,Dem_Actual,GOP_Actual,Actual_Margin,Poll_Error,Poll_Source,Winner
2000,Al Gore,George W. Bush,46.0,48.0,-2.0,48.4,47.9,0.5,2.5,Gallup,R
2004,John Kerry,George W. Bush,49.0,49.0,0.0,48.3,50.7,-2.4,-2.4,Gallup/RCP,R
2008,Barack Obama,John McCain,52.0,45.0,7.0,52.9,45.7,7.2,0.2,RCP,D
2012,Barack Obama,Mitt Romney,49.0,48.0,1.0,51.1,47.2,3.9,2.9,RCP,D
2016,Hillary Clinton,Donald Trump,46.8,43.6,3.2,48.2,46.1,2.1,-1.1,RCP,R
2020,Joe Biden,Donald Trump,51.4,46.9,4.5,51.3,46.9,4.4,-0.1,RCP,D
2024,Kamala Harris,Donald Trump,48.7,48.6,0.1,48.4,49.9,-1.5,-1.6,RCP,R`;

    const nationalRows = d3.csvParse(nationalCSV);
    for (const row of nationalRows) {
      const year = parseInt(row.Year);
      DATA.national[year] = {
        D: parseFloat(row.Dem_Poll_Avg),
        R: parseFloat(row.GOP_Poll_Avg),
        actualD: parseFloat(row.Dem_Actual),
        actualR: parseFloat(row.GOP_Actual),
        winner: row.Winner,
        demCandidate: row.Dem_Candidate,
        gopCandidate: row.GOP_Candidate
      };
    }

    // Load state partisan indices
    const ratiosCSV = `State,1996_Dem_Index,1996_GOP_Index,2000_Dem_Index,2000_GOP_Index,2004_Dem_Index,2004_GOP_Index,2008_Dem_Index,2008_GOP_Index,2012_Dem_Index,2012_GOP_Index,2016_Dem_Index,2016_GOP_Index,2020_Dem_Index,2020_GOP_Index,2024_Dem_Index,2024_GOP_Index
Alabama,0.878,1.231,0.8595,1.1795,0.7619,1.2327,0.7316,1.3195,0.7515,1.2818,0.7137,1.3442,0.7127,1.3237,0.7054,1.2963
Alaska,0.6768,1.2482,0.5723,1.2234,0.735,1.2051,0.7164,1.2998,0.7984,1.161,0.7593,1.1104,0.8336,1.1274,0.8566,1.095
Arizona,0.9451,1.0885,0.9236,1.0647,0.9193,1.0828,0.8526,1.1729,0.8728,1.1377,0.9357,1.0541,0.962,1.0469,0.9659,1.0484
Arkansas,1.0915,0.9042,0.9483,1.071,0.9213,1.071,0.7353,1.2845,0.7221,1.2839,0.6992,1.3117,0.6778,1.3316,0.6942,1.2889
California,1.0386,0.9386,1.1033,0.8706,1.1242,0.8757,1.1531,0.8096,1.1781,0.786,1.2801,0.684,1.2372,0.7324,1.2096,0.7695
Colorado,0.9024,1.1253,0.876,1.0605,0.9731,1.0197,1.0151,0.9781,1.0078,0.9767,1.0,0.9372,1.0797,0.8942,1.1198,0.8661
Connecticut,1.0732,0.8526,1.155,0.8017,1.1242,0.8659,1.1456,0.8359,1.137,0.8623,1.1328,0.8853,1.1546,0.8367,1.1667,0.841
Delaware,1.0528,0.8993,1.1364,0.8747,1.1035,0.9034,1.1701,0.8074,1.1468,0.8475,1.1079,0.9069,1.1456,0.8493,1.1715,0.841
District of Columbia,1.7317,0.2285,1.7603,0.1879,1.8468,0.1834,1.7486,0.1422,1.7789,0.1547,1.8859,0.0887,1.7959,0.1152,1.8676,0.1299
Florida,0.9756,1.0393,1.0083,1.0188,0.9752,1.0276,0.9641,1.0547,0.9785,1.0403,0.9917,1.0606,0.9328,1.093,0.8893,1.1261
Georgia,0.9309,1.1548,0.8884,1.142,0.8571,1.144,0.8885,1.1422,0.8904,1.1292,0.9523,1.1039,0.9647,1.0512,1.0039,1.0185
Hawaii,1.1565,0.7764,1.1529,0.7829,1.118,0.8935,1.3573,0.5821,1.3796,0.589,1.2905,0.6494,1.2421,0.7313,1.2534,0.7525
Idaho,0.6829,1.2826,0.5702,1.4029,0.6273,1.3491,0.6824,1.3457,0.638,1.3665,0.5705,1.2835,0.6445,1.3624,0.6287,1.3429
Illinois,1.1037,0.9042,1.1281,0.8894,1.1346,0.8777,1.1701,0.8053,1.1272,0.8623,1.1577,0.8398,1.1214,0.8653,1.1247,0.8727
Indiana,0.8455,1.1572,0.8471,1.1816,0.8137,1.1815,0.9433,1.07,0.8591,1.1462,0.7842,1.2316,0.7983,1.2168,0.8196,1.1761
Iowa,1.0224,0.9803,1.0021,1.0063,1.0186,0.9842,1.0151,0.9672,1.0176,0.9788,0.8651,1.1061,0.8749,1.1329,0.8796,1.1189
Kansas,0.7337,1.3342,0.7686,1.2109,0.7578,1.2229,0.7883,1.2385,0.7436,1.2648,0.749,1.2273,0.81,1.1995,0.849,1.1476
Kentucky,0.9309,1.1032,0.8554,1.1795,0.8219,1.1736,0.7788,1.256,0.7397,1.2818,0.6784,1.3528,0.7045,1.325,0.7021,1.2943
Louisiana,1.0569,0.9803,0.9277,1.0981,0.8737,1.1183,0.7543,1.2823,0.7945,1.2246,0.7967,1.2576,0.7767,1.2475,0.7904,1.209
Maine,1.0488,0.7568,1.0145,0.9186,1.1097,0.8797,1.0907,0.884,1.1018,0.8686,0.9917,0.9719,1.0347,0.9394,1.0848,0.9135
Maryland,1.1037,0.941,1.1674,0.8413,1.1573,0.8462,1.1701,0.7987,1.2133,0.7606,1.251,0.7338,1.2738,0.6861,1.2954,0.6842
Massachusetts,1.25,0.6904,1.2355,0.6785,1.2816,0.7258,1.1682,0.7877,1.1879,0.7945,1.2448,0.71,1.2785,0.6859,1.2664,0.7231
Michigan,1.0508,0.9459,1.0599,0.9624,1.06,0.9428,1.0851,0.8972,1.0607,0.947,0.9813,1.0281,0.9866,1.0209,0.9994,0.9984
Minnesota,1.0386,0.86,0.9897,0.9499,1.058,0.9389,1.0227,0.9584,1.0313,0.9534,0.9627,0.9719,1.0212,0.9663,1.0534,0.9372
Mississippi,0.8963,1.2088,0.8409,1.2025,0.824,1.1736,0.8129,1.2298,0.8571,1.1716,0.832,1.2532,0.8002,1.2292,0.7861,1.2224
Missouri,0.9654,1.0123,0.9731,1.0522,0.9545,1.0513,0.9319,1.081,0.8689,1.1398,0.7905,1.2294,0.8071,1.2121,0.8291,1.1743
Montana,0.8394,1.0835,0.6901,1.2192,0.7992,1.1657,0.8941,1.0832,0.816,1.1737,0.7448,1.2229,0.7903,1.2147,0.7956,1.1723
Nebraska,0.7114,1.3194,0.688,1.2985,0.677,1.2998,0.7864,1.2363,0.7436,1.2669,0.6992,1.2706,0.7671,1.2486,0.808,1.1971
Nevada,0.8923,1.0541,0.9504,1.0334,0.9917,0.9961,1.0416,0.9344,1.0254,0.9682,0.9938,0.9848,0.9756,1.0173,0.9824,1.0157
New Hampshire,1.002,0.9681,0.9669,1.0042,1.0393,0.9645,1.0284,0.9781,1.0176,0.9852,0.971,1.0065,1.0273,0.968,1.0478,0.9611
New Jersey,1.0915,0.8821,1.1591,0.8413,1.0952,0.9112,1.0832,0.9125,1.1409,0.8602,1.1515,0.8961,1.1173,0.8835,1.0751,0.9247
New Mexico,1.0,1.0295,0.9897,0.9979,1.0145,0.9822,1.0756,0.9147,1.0372,0.9068,1.0021,0.8658,1.0581,0.9283,1.0726,0.9205
New York,1.2093,0.7518,1.2438,0.7349,1.2091,0.7909,1.1871,0.7899,1.2407,0.7458,1.222,0.7922,1.1861,0.8056,1.1566,0.8695
North Carolina,0.8943,1.1966,0.8926,1.1691,0.9027,1.1045,0.9395,1.081,0.9472,1.0678,0.9585,1.0779,0.947,1.0655,0.9857,1.0211
North Dakota,0.815,1.1523,0.6839,1.2672,0.735,1.2406,0.8431,1.1663,0.7573,1.2352,0.5643,1.3636,0.619,1.3895,0.6312,1.3443
Ohio,0.9634,1.0074,0.9587,1.0438,1.0083,1.002,0.9735,1.0263,0.9922,1.0106,0.9046,1.119,0.8817,1.1368,0.9088,1.107
Oklahoma,0.8211,1.1867,0.7934,1.2589,0.7122,1.2939,0.6503,1.4354,0.6497,1.4153,0.5996,1.4134,0.6293,1.395,0.6599,1.3282
Oregon,0.9593,0.9607,0.9711,0.9708,1.0621,0.931,1.0718,0.884,1.0607,0.8919,1.0394,0.8463,1.1002,0.8615,1.1434,0.8225
Pennsylvania,1.0,0.9828,1.0455,0.9687,1.0538,0.9546,1.0265,0.9628,1.0196,0.9894,0.9938,1.0519,0.9747,1.0423,1.0066,1.0112
Rhode Island,1.2134,0.6585,1.2603,0.666,1.2298,0.7633,1.1928,0.7702,1.227,0.7458,1.1286,0.842,1.1575,0.8239,1.1489,0.8384
South Carolina,0.8943,1.2236,0.845,1.1858,0.8468,1.144,0.8488,1.1794,0.863,1.1568,0.8444,1.1883,0.8464,1.1761,0.8349,1.169
South Dakota,0.874,1.1425,0.7769,1.2589,0.795,1.1815,0.845,1.1641,0.7808,1.2267,0.6577,1.3312,0.694,1.3182,0.7083,1.2734
Tennessee,0.9756,1.1204,0.9773,1.0668,0.8799,1.1203,0.7902,1.2451,0.7652,1.2606,0.7199,1.3139,0.7299,1.2945,0.7131,1.2887
Texas,0.8902,1.199,0.7851,1.238,0.7909,1.2051,0.8261,1.2144,0.8102,1.2119,0.8963,1.1299,0.9059,1.111,0.8784,1.1271
Utah,0.6768,1.3366,0.5434,1.3946,0.5383,1.4103,0.6503,1.3698,0.4834,1.5424,0.5705,0.9848,0.7338,1.2405,0.7818,1.1921
Vermont,1.0854,0.7641,1.0455,0.8497,1.2195,0.7653,1.276,0.6652,1.3033,0.6568,1.1763,0.6558,1.2881,0.6545,1.3204,0.6489
Virginia,0.9167,1.1572,0.9174,1.096,0.942,1.0592,0.9943,1.0131,1.002,1.0021,1.0332,0.961,1.0546,0.939,1.0722,0.9245
Washington,1.0122,0.9165,1.0372,0.9311,1.0932,0.8994,1.0907,0.8862,1.0998,0.875,1.1266,0.8247,1.1298,0.8274,1.1839,0.7832
West Virginia,1.0467,0.9042,0.9421,1.0835,0.8944,1.1065,0.8053,1.2188,0.6947,1.3199,0.5498,1.4848,0.5788,1.4646,0.5815,1.4049
Wisconsin,0.9919,0.9459,0.9876,0.9937,1.029,0.9724,1.0624,0.9256,1.0352,0.9746,0.9647,1.0216,0.9637,1.0418,1.0103,0.9978
Wyoming,0.748,1.2236,0.5723,1.4154,0.6025,1.359,0.6125,1.4092,0.544,1.4534,0.4544,1.4762,0.5174,1.4925,0.5345,1.4375`;

    const ratiosRows = d3.csvParse(ratiosCSV);
    
    // For each election year, use the PREVIOUS election's ratios
    const ratioYearMap = {
      2000: "1996",
      2004: "2000",
      2008: "2004",
      2012: "2008",
      2016: "2012",
      2020: "2016",
      2024: "2020"
    };

    for (const year of YEARS) {
      DATA.ratios[year] = {};
      const prevYear = ratioYearMap[year];
      
      for (const row of ratiosRows) {
        const stateName = row.State;
        const usps = NAME_TO_USPS[stateName];
        if (!usps) continue;
        
        const dIdx = parseFloat(row[`${prevYear}_Dem_Index`]);
        const rIdx = parseFloat(row[`${prevYear}_GOP_Index`]);
        
        if (isFinite(dIdx) && isFinite(rIdx)) {
          DATA.ratios[year][usps] = { D: dIdx, R: rIdx };
        }
      }
    }

    // Load state polling data
    const pollsCSV = `State,2000_Poll_Margin,2000_Actual_Margin,2004_Poll_Margin,2004_Actual_Margin,2008_Poll_Margin,2008_Actual_Margin,2012_Poll_Margin,2012_Actual_Margin,2016_Poll_Margin,2016_Actual_Margin,2020_Poll_Margin,2020_Actual_Margin,2024_Poll_Margin,2024_Actual_Margin
Pennsylvania,2.0,4.2,1.0,2.5,10.5,10.3,3.7,5.4,2.1,-0.7,4.2,1.2,0.0,-1.9
Michigan,4.0,5.2,2.0,3.4,16.0,16.4,2.6,9.5,3.6,-0.2,6.5,2.8,1.1,-1.4
Wisconsin,1.0,0.2,1.0,0.4,11.0,13.9,1.5,6.9,6.5,-0.7,6.0,0.6,1.4,-0.6
Florida,-2.0,0.0,-3.0,-5.0,2.0,2.8,-0.6,0.9,-0.2,-1.2,0.5,-3.3,-5.0,-13.1
Ohio,-3.0,-3.6,-2.0,-2.1,6.0,4.6,2.8,3.0,-2.2,-8.1,-1.0,-8.1,-8.0,-11.4
North Carolina,,,,,0.0,0.3,-2.8,-2.0,-0.8,-3.6,0.3,-1.5,-0.7,-3.4
Arizona,,,,,,,,,,-3.0,-3.6,0.9,0.3,-1.0,-5.5
Nevada,-4.0,-3.5,-3.0,-2.6,7.0,12.5,3.7,6.7,0.8,2.4,2.4,2.4,0.6,-3.6
Georgia,,,,,,,,,,-4.8,-5.1,-1.0,0.2,0.1,-2.7
Iowa,0.0,0.3,-1.0,-0.7,9.5,9.5,2.5,5.7,-3.0,-9.4,-2.9,-8.2,-4.0,-12.8
Virginia,,,,,7.0,6.3,2.0,3.9,5.3,5.3,11.0,10.1,7.0,5.6
Colorado,,,,-4.0,-4.7,7.5,9.3,0.2,5.4,3.9,4.9,11.0,13.5,9.0,10.8
New Hampshire,-2.0,-1.3,0.0,1.3,9.0,9.6,2.0,5.6,1.0,0.4,9.0,7.3,5.0,6.1
Minnesota,5.0,2.4,2.0,3.5,,,,,,3.7,1.5,6.7,7.1,5.0,5.4`;

    const pollsRows = d3.csvParse(pollsCSV);
    
    for (const year of YEARS) {
      DATA.polls[year] = {};
      DATA.actuals[year] = {};
    }
    
    for (const row of pollsRows) {
      const stateName = row.State;
      const usps = NAME_TO_USPS[stateName];
      if (!usps) continue;
      
      for (const year of YEARS) {
        const pollMargin = parseFloat(row[`${year}_Poll_Margin`]);
        const actualMargin = parseFloat(row[`${year}_Actual_Margin`]);
        
        if (isFinite(pollMargin)) {
          DATA.polls[year][usps] = pollMargin;  // D - R margin
        }
        if (isFinite(actualMargin)) {
          DATA.actuals[year][usps] = actualMargin;  // D - R margin
        }
      }
    }

    if (errBox) errBox.hidden = true;
    return true;
  } catch(err) {
    if (errBox) {
      errBox.hidden = false;
      errBox.innerHTML = `Error loading data: <span class="mono">${String(err.message || err)}</span>`;
    }
    return false;
  }
}

/* ---------- Model computation ---------- */
function getStateModel(year, st) {
  const national = DATA.national[year];
  const ratios = DATA.ratios[year];
  const polls = DATA.polls[year];
  
  if (!national || !ratios || !ratios[st]) return null;
  
  const ratio = ratios[st];
  
  // Generic ballot component
  const gbPair = normalizePair(national.D * ratio.D, national.R * ratio.R);
  const gbMargin = marginRD(gbPair);
  
  // Poll component (if available)
  const pollMargin = polls[st];
  const hasPoll = isFinite(pollMargin);
  
  let pollPair = null;
  if (hasPoll) {
    // Convert margin back to pair (margin is D - R)
    const baseD = 50 + pollMargin / 2;
    const baseR = 50 - pollMargin / 2;
    pollPair = normalizePair(baseD, baseR);
  }
  
  // Indicator component (median of poll-implied national from all polled states)
  const indNat = computeIndicatorNational(year);
  let indPair = null;
  if (indNat) {
    indPair = normalizePair(indNat.D * ratio.D, indNat.R * ratio.R);
  }
  
  // Weighted combination
  const comps = [
    { pair: gbPair, w: WEIGHTS.gb, sigma: 5 },
    { pair: pollPair, w: hasPoll ? WEIGHTS.polls : 0, sigma: 3 },
    { pair: indPair, w: indPair ? WEIGHTS.ind : 0, sigma: 5 }
  ];
  
  const combined = weightedCombine(comps);
  const mFinal = marginRD(combined.pair);
  const winProb = winProbFromMargin(mFinal);
  
  // Get actual result if available
  const actualMargin = DATA.actuals[year]?.[st];
  
  return {
    gbPair,
    pollPair,
    indPair,
    combinedPair: combined.pair,
    combinedSigma: combined.sigma,
    winProb,
    actualMargin: isFinite(actualMargin) ? -actualMargin : null  // Convert to R-D for display
  };
}

function computeIndicatorNational(year) {
  const national = DATA.national[year];
  const ratios = DATA.ratios[year];
  const polls = DATA.polls[year];
  
  if (!national || !ratios || !polls) return null;
  
  const implied = [];
  
  for (const st of Object.keys(polls)) {
    const pollMargin = polls[st];
    const ratio = ratios[st];
    if (!isFinite(pollMargin) || !ratio) continue;
    
    // Convert poll margin to pair
    const pollD = 50 + pollMargin / 2;
    const pollR = 50 - pollMargin / 2;
    
    // Implied national = poll / ratio
    implied.push({
      D: pollD / ratio.D,
      R: pollR / ratio.R
    });
  }
  
  if (implied.length === 0) return null;
  
  const medD = median(implied.map(x => x.D));
  const medR = median(implied.map(x => x.R));
  
  return normalizePair(medD, medR);
}

function median(arr) {
  const a = arr.filter(x => isFinite(x)).slice().sort((x, y) => x - y);
  const n = a.length;
  if (n === 0) return NaN;
  const mid = Math.floor(n / 2);
  return (n % 2 === 1) ? a[mid] : (a[mid - 1] + a[mid]) / 2;
}

function weightedCombine(components) {
  let W = 0, D = 0, R = 0, sig2 = 0;
  for (const c of components) {
    if (!c || !c.pair || !isFinite(c.w) || c.w <= 0) continue;
    W += c.w;
    D += c.w * c.pair.D;
    R += c.w * c.pair.R;
    sig2 += c.w * (c.sigma * c.sigma);
  }
  if (W <= 0) return { pair: {D: 50, R: 50}, sigma: 6 };
  return { pair: normalizePair(D / W, R / W), sigma: Math.sqrt(sig2 / W) };
}

/* ---------- Monte Carlo simulation ---------- */
function runSimulation(year) {
  const states = Object.keys(DATA.ratios[year] || {});
  const stateModels = {};
  
  for (const st of states) {
    const model = getStateModel(year, st);
    if (model) {
      stateModels[st] = {
        margin: marginRD(model.combinedPair),
        ev: EV_BY_STATE[st] || 0
      };
    }
  }
  
  const histogram = {};
  for (let ev = 0; ev <= 538; ev++) histogram[ev] = 0;
  
  for (let sim = 0; sim < MC_SIMS; sim++) {
    // Apply national swing
    const swing = (Math.random() - 0.5) * 14;  // +/- 7 pts
    let demEV = 0;
    
    for (const st of Object.keys(stateModels)) {
      const { margin, ev } = stateModels[st];
      const adjMargin = margin + swing;
      const pD = winProbD_fast(adjMargin);
      if (Math.random() < pD) {
        demEV += ev;
      }
    }
    
    histogram[demEV] = (histogram[demEV] || 0) + 1;
  }
  
  // Convert to probabilities
  for (const ev of Object.keys(histogram)) {
    histogram[ev] /= MC_SIMS;
  }
  
  return histogram;
}

/* ---------- UI Rendering ---------- */
function updateUI() {
  const year = currentYear;
  const national = DATA.national[year];
  
  // Update header
  document.getElementById("electionTitle").textContent = `${year} Presidential Election`;
  document.getElementById("candidateNames").textContent = 
    `${national.demCandidate} (D) vs ${national.gopCandidate} (R)`;
  document.getElementById("nationalD").textContent = national.D.toFixed(1);
  document.getElementById("nationalR").textContent = national.R.toFixed(1);
  
  // Winner badge
  const winnerEl = document.getElementById("actualWinner");
  winnerEl.innerHTML = `<span class="winnerBadge ${national.winner.toLowerCase()}">
    Winner: ${national.winner === 'D' ? national.demCandidate : national.gopCandidate}
  </span>`;
  
  // Calculate electoral votes
  let evD = 0, evR = 0;
  const states = Object.keys(DATA.ratios[year] || {});
  
  for (const st of states) {
    const model = getStateModel(year, st);
    if (!model) continue;
    
    const margin = marginRD(model.combinedPair);
    const ev = EV_BY_STATE[st] || 0;
    
    if (margin < 0) evD += ev;
    else evR += ev;
  }
  
  document.getElementById("evD").textContent = evD;
  document.getElementById("evR").textContent = evR;
  
  // Update map
  recolorMap();
  
  // Update bucket table
  renderBucketTable();
  
  // Update simulation histogram
  const histogram = runSimulation(year);
  drawSimHistogram(histogram);
}

function recolorMap() {
  if (!MAP?.gRoot) return;
  
  const year = currentYear;
  
  MAP.gRoot.selectAll("path.state").each(function() {
    const st = this.getAttribute("data-st");
    const hasRatios = st && DATA.ratios[year] && DATA.ratios[year][st];
    
    if (!hasRatios) {
      this.style.fill = "#e5e7eb";
      this.classList.remove("active");
      return;
    }
    
    this.classList.add("active");
    const model = getStateModel(year, st);
    
    if (!model) {
      this.style.fill = "#e5e7eb";
      return;
    }
    
    const mm = marginRD(model.combinedPair);
    this.style.fill = interpColor(mm);
  });
}

function renderBucketTable() {
  const year = currentYear;
  const bucketBody = document.getElementById("bucketBody");
  const BUCKET_ORDER = ["Likely D", "Lean D", "Tossup", "Lean R", "Likely R"];
  
  const buckets = {};
  for (const k of BUCKET_ORDER) buckets[k] = [];
  
  const states = Object.keys(DATA.ratios[year] || {});
  
  for (const st of states) {
    const model = getStateModel(year, st);
    if (!model) continue;
    
    const mm = marginRD(model.combinedPair);
    const bKey = bucketKeyFromMargin(mm);
    if (!bKey) continue;
    
    let cls = "t";
    if (bKey === "Likely D" || bKey === "Lean D") cls = "d";
    if (bKey === "Lean R" || bKey === "Likely R") cls = "r";
    
    buckets[bKey].push({
      st,
      name: USPS_TO_NAME[st] || st,
      m: mm,
      absM: Math.abs(mm),
      ev: EV_BY_STATE[st] || 0,
      cls
    });
  }
  
  for (const k of BUCKET_ORDER) {
    buckets[k].sort((a, b) => a.absM - b.absM);
  }
  
  const maxLen = Math.max(...BUCKET_ORDER.map(k => buckets[k].length), 0);
  
  if (maxLen === 0) {
    bucketBody.innerHTML = `<tr><td colspan="5"><div class="raceEmpty" style="height:72px;justify-content:center;">No competitive states</div></td></tr>`;
    return;
  }
  
  bucketBody.innerHTML = "";
  for (let i = 0; i < maxLen; i++) {
    const tr = document.createElement("tr");
    
    for (const k of BUCKET_ORDER) {
      const td = document.createElement("td");
      const item = buckets[k][i];
      
      if (!item) {
        const ph = document.createElement("div");
        ph.className = "raceEmpty";
        ph.innerHTML = "—";
        td.appendChild(ph);
      } else {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = `raceItem ${item.cls}`;
        btn.title = item.name;
        
        const top = document.createElement("div");
        top.className = "raceTop";
        top.textContent = `${item.st} • ${item.ev} EV`;
        
        const mid = document.createElement("div");
        mid.className = "raceName";
        mid.textContent = item.name;
        
        const bot = document.createElement("div");
        bot.className = "raceBottom";
        bot.textContent = fmtLead(item.m);
        
        btn.appendChild(top);
        btn.appendChild(mid);
        btn.appendChild(bot);
        
        btn.addEventListener("mouseenter", () => {
          const rect = btn.getBoundingClientRect();
          showTooltip({ clientX: rect.left + rect.width/2, clientY: rect.top }, item.st);
          MAP?.gRoot?.selectAll("path.state").classed("focus", false);
          MAP?.gRoot?.selectAll(`path.state[data-st='${item.st}']`).classed("focus", true);
        });
        btn.addEventListener("mouseleave", () => {
          hideTooltip();
          MAP?.gRoot?.selectAll("path.state").classed("focus", false);
        });
        
        td.appendChild(btn);
      }
      
      tr.appendChild(td);
    }
    
    bucketBody.appendChild(tr);
  }
}

function drawSimHistogram(histogram) {
  const canvas = document.getElementById("simCanvas");
  const ctx = canvas.getContext("2d");
  const dpr = window.devicePixelRatio || 1;
  
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  
  const w = rect.width;
  const h = rect.height;
  
  ctx.clearRect(0, 0, w, h);
  
  // Find max probability for scaling
  let maxP = 0;
  for (const ev of Object.keys(histogram)) {
    if (histogram[ev] > maxP) maxP = histogram[ev];
  }
  
  if (maxP === 0) return;
  
  // Draw bars
  const barWidth = w / 539;
  
  for (let ev = 0; ev <= 538; ev++) {
    const p = histogram[ev] || 0;
    if (p === 0) continue;
    
    const barH = (p / maxP) * h * 0.9;
    const x = (ev / 538) * w;
    const y = h - barH;
    
    // Color based on winner
    if (ev >= 270) {
      ctx.fillStyle = "#2563eb";
    } else {
      ctx.fillStyle = "#dc2626";
    }
    
    ctx.fillRect(x, y, Math.max(barWidth, 1), barH);
  }
  
  // Draw 270 line
  const x270 = (270 / 538) * w;
  ctx.strokeStyle = "#111827";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(x270, 0);
  ctx.lineTo(x270, h);
  ctx.stroke();
}

/* ---------- Tooltip ---------- */
function showTooltip(event, st) {
  const tip = document.getElementById("tip");
  const year = currentYear;
  const model = getStateModel(year, st);
  
  if (!model) {
    hideTooltip();
    return;
  }
  
  const name = USPS_TO_NAME[st] || st;
  const ev = EV_BY_STATE[st] || 0;
  const mFinal = marginRD(model.combinedPair);
  const wp = model.winProb;
  
  document.getElementById("tipTitle").textContent = name;
  document.getElementById("tipMeta").textContent = `${ev} Electoral Votes`;
  
  // Badges
  const tipSub = document.getElementById("tipSub");
  tipSub.innerHTML = `
    <span class="badge"><span class="dot blue"></span>${model.combinedPair.D.toFixed(1)}%</span>
    <span class="badge"><span class="dot red"></span>${model.combinedPair.R.toFixed(1)}%</span>
    <span class="badge">${fmtLead(mFinal)}</span>
  `;
  
  // Body with model factors
  let bodyHTML = "";
  
  // Generic ballot factor
  if (model.gbPair) {
    bodyHTML += miniRowHTML("Fundamentals", marginRD(model.gbPair));
  }
  
  // Poll factor
  if (model.pollPair) {
    bodyHTML += miniRowHTML("State Polls", marginRD(model.pollPair));
  }
  
  // Indicator factor
  if (model.indPair) {
    bodyHTML += miniRowHTML("Indicator", marginRD(model.indPair));
  }
  
  // Win probability
  bodyHTML += `<div class="miniRow">
    <span class="miniLbl">Win Prob</span>
    <span class="miniVal">${(wp.pD * 100).toFixed(0)}% D</span>
    <span class="miniVal">${(wp.pR * 100).toFixed(0)}% R</span>
  </div>`;
  
  // Actual result if available
  if (model.actualMargin !== null) {
    const actualM = model.actualMargin;
    const actualCls = actualM < 0 ? 'd' : 'r';
    bodyHTML += `<div class="actualRow">
      <div class="actualLabel">Actual Result</div>
      <div class="actualValue ${actualCls}">${fmtLead(actualM)}</div>
    </div>`;
  }
  
  document.getElementById("tipBody").innerHTML = bodyHTML;
  
  tip.style.transform = "";
  positionTooltip(event);
}

function miniRowHTML(label, m) {
  const min = -25, max = 25;
  const mm = clamp(m, min, max);
  const toPct = v => ((v - min) / (max - min)) * 100;
  
  const markerPct = toPct(mm);
  const barLeft = mm < 0 ? markerPct : 50;
  const barWidth = Math.abs(markerPct - 50);
  const fillClass = mm < 0 ? "blue" : "red";
  
  return `<div class="miniRow">
    <span class="miniLbl">${label}</span>
    <span class="miniVal">${fmtLead(m)}</span>
    <div class="miniBar">
      <div class="miniZero"></div>
      <div class="miniFill ${fillClass}" style="left:${barLeft}%;width:${barWidth}%"></div>
    </div>
  </div>`;
}

function positionTooltip(event) {
  const tip = document.getElementById("tip");
  const tipW = tip.offsetWidth;
  const tipH = tip.offsetHeight;
  const pad = 12;
  
  let x = event.clientX + pad;
  let y = event.clientY + pad;
  
  if (x + tipW > window.innerWidth - pad) {
    x = event.clientX - tipW - pad;
  }
  if (y + tipH > window.innerHeight - pad) {
    y = event.clientY - tipH - pad;
  }
  
  tip.style.transform = `translate(${x}px, ${y}px)`;
}

function hideTooltip() {
  document.getElementById("tip").style.transform = "translate(-9999px, -9999px)";
}

/* ---------- Map initialization ---------- */
let STATE_GEO = null;

async function loadStateGeo() {
  if (STATE_GEO) return STATE_GEO;
  const topo = await fetch("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json").then(r => r.json());
  const geo = topojson.feature(topo, topo.objects.states);
  STATE_GEO = geo;
  return STATE_GEO;
}

async function initMap() {
  const geo = await loadStateGeo();
  const features = geo.features;
  
  const width = 960, height = 600;
  const svg = d3.select("#mapSvg");
  svg.attr("viewBox", `0 0 ${width} ${height}`);
  
  const projection = d3.geoAlbersUsa();
  projection.fitExtent([[18, 18], [width - 18, height - 18]], geo);
  const pathGen = d3.geoPath(projection);
  
  svg.selectAll("*").remove();
  const gRoot = svg.append("g");
  
  gRoot.selectAll("path")
    .data(features)
    .join("path")
    .attr("class", d => {
      const st = fipsToUsps(d.id);
      const hasRatios = st && DATA.ratios[currentYear] && DATA.ratios[currentYear][st];
      return hasRatios ? "state active" : "state";
    })
    .attr("data-st", d => fipsToUsps(d.id))
    .attr("d", d => pathGen(d))
    .attr("fill", "#e5e7eb")
    .on("mouseenter", function(event, d) {
      const st = fipsToUsps(d.id);
      if (!st) return;
      d3.select(this).classed("hovered", true);
      showTooltip(event, st);
    })
    .on("mousemove", function(event, d) {
      const st = fipsToUsps(d.id);
      if (!st) return;
      positionTooltip(event);
    })
    .on("mouseleave", function(event) {
      d3.select(this).classed("hovered", false);
      hideTooltip();
    });
  
  MAP = { svg, gRoot };
}

/* ---------- Segmented control ---------- */
function initSegmentedControl() {
  const seg = document.querySelector(".seg");
  const buttons = seg.querySelectorAll("button");
  
  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      const year = parseInt(btn.dataset.val);
      currentYear = year;
      
      // Update active state
      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      seg.dataset.year = year;
      
      // Update UI
      updateUI();
    });
  });
}

/* ---------- Boot ---------- */
(async function boot() {
  const ok = await loadData();
  if (!ok) return;
  
  await initMap();
  initSegmentedControl();
  updateUI();
  
  // Handle resize
  window.addEventListener("resize", () => {
    const histogram = runSimulation(currentYear);
    drawSimHistogram(histogram);
  }, { passive: true });
})();
</script>
</body>
</html>
