<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Presidential Forecast 2024</title>

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --blue: #2563eb;
      --red: #dc2626;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg); color: var(--text);
    }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 18px; }
    .top {
      display: flex; align-items: baseline; justify-content: space-between; gap: 12px; flex-wrap: wrap;
      margin-bottom: 14px;
    }
    h1 { font-size: 18px; margin: 0; letter-spacing: -0.01em; }
    .sub { color: var(--muted); font-size: 12px; }
    .grid {
      display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;
    }
    .card {
      background: var(--card); border: 1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow);
      padding: 12px 12px;
    }
    .k { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: .08em; margin-bottom: 6px; }
    .v { font-size: 18px; font-weight: 700; }
    .row { display:flex; gap: 10px; align-items: baseline; flex-wrap: wrap; }
    .pill {
      display:inline-flex; align-items:center; gap:6px; padding: 3px 8px; border-radius: 999px;
      border: 1px solid var(--border); color: var(--muted); font-size: 12px;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .mapCard { padding: 10px; }
    .mapHead { display:flex; align-items: baseline; justify-content: space-between; gap: 12px; flex-wrap: wrap; margin-bottom: 6px; }
    .mapTitle { font-weight: 700; font-size: 13px; }
    svg { width: 100%; height: auto; }
    .state { stroke: #ffffff; stroke-width: 0.8; }
    .legend { display:flex; gap:10px; align-items:center; flex-wrap: wrap; font-size: 12px; color: var(--muted); }
    .swatch { width: 14px; height: 10px; border-radius: 3px; border: 1px solid var(--border); }
    .tableCard { padding: 0; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      text-align: left; font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: .08em;
      padding: 10px 12px; border-bottom: 1px solid var(--border);
    }
    tbody td { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 13px; }
    tbody tr:last-child td { border-bottom: none; }
    .right { text-align: right; }
    #tooltip {
      position: fixed; z-index: 50; pointer-events: none;
      background: rgba(15,23,42,.95); color: white;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 10px; padding: 10px 10px;
      font-size: 12px; width: 240px;
      transform: translate(10px, 10px);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      display:none;
    }
    #loadError {
      background: #fff1f2; border: 1px solid #fecdd3; color: #9f1239;
      border-radius: 12px; padding: 10px 12px; margin-bottom: 12px; font-size: 13px;
    }
    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Presidential Election Forecast — 2024</h1>
        <div class="sub">Ratios from previous presidential election: <span class="mono">2020</span> • Data: <span class="mono">national_polling_averages_2000_2024.csv</span>, <span class="mono">battleground_polling_summary_2000_2024.csv</span></div>
      </div>
      <div class="row">
        <span class="pill"><span class="mono">WEIGHTS</span> GB 35 • Polls 50 • Ind 15</span>
        <span class="pill"><span class="mono">TOSSUP</span> |margin| ≤ 2.0 → yellow</span>
      </div>
    </div>

    <div id="loadError" hidden></div>

    <div class="grid">
      <div class="card">
        <div class="k">National polling (two-party normalized)</div>
        <div class="v" id="natPoll">—</div>
        <div class="sub" id="natPollMeta"></div>
      </div>
      <div class="card">
        <div class="k">Implied national (from battleground polls ÷ ratios)</div>
        <div class="v" id="indNat">—</div>
        <div class="sub">Median across available battleground polls.</div>
      </div>
      <div class="card">
        <div class="k">Projected electoral votes (winner-take-all)</div>
        <div class="v" id="evTotal">—</div>
        <div class="sub" id="evMeta"></div>
      </div>
    </div>

    <div class="card mapCard">
      <div class="mapHead">
        <div class="mapTitle">State forecast margin (R − D)</div>
        <div class="legend">
          <span class="swatch" style="background: rgb(248,250,252)"></span> <span>near tie</span>
          <span class="swatch" style="background: rgb(253,224,71)"></span> <span>ultra-close</span>
          <span class="swatch" style="background: rgb(37,99,235)"></span> <span>D lead</span>
          <span class="swatch" style="background: rgb(220,38,38)"></span> <span>R lead</span>
        </div>
      </div>
      <svg id="map" aria-label="US states map"></svg>
    </div>

    <div class="card tableCard" style="margin-top: 12px;">
      <table>
        <thead>
          <tr>
            <th>Closest states</th>
            <th class="right">EV</th>
            <th class="right">Forecast</th>
            <th class="right">GB</th>
            <th class="right">Poll</th>
            <th class="right">Ind</th>
          </tr>
        </thead>
        <tbody id="closestBody"></tbody>
      </table>
    </div>
  </div>

  <div id="tooltip"></div>

<script>
const YEAR = 2024;
const PREV_YEAR = 2020;
const RATIOS = {"AK":{"D":0.8559379027256596,"R":1.157752321572659},"AL":{"D":0.7095858709977498,"R":1.318012190120786},"AR":{"D":0.6846938000325281,"R":1.345269755141773},"AZ":{"D":0.9596090157995394,"R":1.0442293403246332},"CA":{"D":1.2418483078417406,"R":0.7351688421014734},"CO":{"D":1.0893535915272223,"R":0.9021551346886778},"CT":{"D":1.1516618948531256,"R":0.8339256719161307},"DC":{"D":1.8073577929966298,"R":0.1159189780330796},"DE":{"D":1.1407889886174913,"R":0.8458318306724258},"FL":{"D":0.9241841516856812,"R":1.0830206300607192},"GA":{"D":0.9588915208607394,"R":1.0450150188233767},"HI":{"D":1.244215976708738,"R":0.7325761736095462},"IA":{"D":0.8765735862218059,"R":1.135155628616312},"ID":{"D":0.6528442925464865,"R":1.380145922030423},"IL":{"D":1.1222747797206585,"R":0.8661054452512469},"IN":{"D":0.7998194362387813,"R":1.2192037271741194},"KS":{"D":0.8132429444023086,"R":1.204504582732168},"KY":{"D":0.7040618766216294,"R":1.3240611298049543},"LA":{"D":0.7755332044788643,"R":1.245797880076688},"MA":{"D":1.284066083980064,"R":0.6889391097606159},"MD":{"D":1.2824111036025847,"R":0.6907513629600636},"ME":{"D":1.0459634585756628,"R":0.9496686329367284},"MI":{"D":0.9836529427708945,"R":1.0179005184400562},"MN":{"D":1.0262402782846702,"R":0.9712661074881029},"MO":{"D":0.8066922351129568,"R":1.211677806070538},"MS":{"D":0.7961855136332345,"R":1.2231829815254474},"MT":{"D":0.7959522108922855,"R":1.223438455031042},"NC":{"D":0.9435185891610116,"R":1.061848840563399},"ND":{"D":0.6272021055857995,"R":1.4082248865865572},"NE":{"D":0.7694183374653328,"R":1.2524938430381025},"NH":{"D":1.0283225102400764,"R":0.9689860009838045},"NJ":{"D":1.111029652858398,"R":0.8784191967685697},"NM":{"D":1.0621891756240422,"R":0.9319009856374633},"NV":{"D":0.9800093740234637,"R":1.0218903356063453},"NY":{"D":1.180776959135355,"R":0.8020438024295827},"OH":{"D":0.8786124142464508,"R":1.1329230507192776},"OK":{"D":0.6325087749501147,"R":1.4024139243148845},"OR":{"D":1.115542422751378,"R":0.8734775782525968},"PA":{"D":0.9678812605144111,"R":1.035170984011084},"RI":{"D":1.1593972376155022,"R":0.825455239359527},"SC":{"D":0.8432196010969355,"R":1.1716792436871681},"SD":{"D":0.6995719971687498,"R":1.3289776826017967},"TN":{"D":0.7303175754496003,"R":1.2953103513351847},"TX":{"D":0.9024506463948534,"R":1.1068194708412389},"UT":{"D":0.7520166174958598,"R":1.271549248842129},"VA":{"D":1.0552288319728367,"R":0.9395227709001768},"VT":{"D":1.3067116281812474,"R":0.6641415589918664},"WA":{"D":1.1465048968868086,"R":0.8395727395135348},"WI":{"D":0.9627128580620836,"R":1.040830539863057},"WV":{"D":0.5778196052602415,"R":1.462300207013028},"WY":{"D":0.5265089998709832,"R":1.5184868603701551}};
const EV = {"AL":9,"AK":3,"AZ":11,"AR":6,"CA":54,"CO":10,"CT":7,"DE":3,"DC":3,"FL":30,"GA":16,"HI":4,"ID":4,"IL":19,"IN":11,"IA":6,"KS":6,"KY":8,"LA":8,"ME":4,"MD":10,"MA":11,"MI":15,"MN":10,"MS":6,"MO":10,"MT":4,"NE":5,"NV":6,"NH":4,"NJ":14,"NM":5,"NY":28,"NC":16,"ND":3,"OH":17,"OK":7,"OR":8,"PA":19,"RI":4,"SC":9,"SD":3,"TN":11,"TX":40,"UT":6,"VT":3,"VA":13,"WA":12,"WV":4,"WI":10,"WY":3};

const FIPS_TO_USPS = {
  1:"AL",2:"AK",4:"AZ",5:"AR",6:"CA",8:"CO",9:"CT",10:"DE",11:"DC",12:"FL",13:"GA",15:"HI",16:"ID",17:"IL",18:"IN",19:"IA",20:"KS",21:"KY",22:"LA",23:"ME",24:"MD",25:"MA",26:"MI",27:"MN",28:"MS",29:"MO",30:"MT",31:"NE",32:"NV",33:"NH",34:"NJ",35:"NM",36:"NY",37:"NC",38:"ND",39:"OH",40:"OK",41:"OR",42:"PA",44:"RI",45:"SC",46:"SD",47:"TN",48:"TX",49:"UT",50:"VT",51:"VA",53:"WA",54:"WV",55:"WI",56:"WY"
};
const USPS_TO_NAME = {
  AL:"Alabama",AK:"Alaska",AZ:"Arizona",AR:"Arkansas",CA:"California",CO:"Colorado",CT:"Connecticut",DE:"Delaware",DC:"District of Columbia",
  FL:"Florida",GA:"Georgia",HI:"Hawaii",ID:"Idaho",IL:"Illinois",IN:"Indiana",IA:"Iowa",KS:"Kansas",KY:"Kentucky",LA:"Louisiana",ME:"Maine",
  MD:"Maryland",MA:"Massachusetts",MI:"Michigan",MN:"Minnesota",MS:"Mississippi",MO:"Missouri",MT:"Montana",NE:"Nebraska",NV:"Nevada",NH:"New Hampshire",
  NJ:"New Jersey",NM:"New Mexico",NY:"New York",NC:"North Carolina",ND:"North Dakota",OH:"Ohio",OK:"Oklahoma",OR:"Oregon",PA:"Pennsylvania",RI:"Rhode Island",
  SC:"South Carolina",SD:"South Dakota",TN:"Tennessee",TX:"Texas",UT:"Utah",VT:"Vermont",VA:"Virginia",WA:"Washington",WV:"West Virginia",WI:"Wisconsin",WY:"Wyoming"
};
const NAME_TO_USPS = Object.fromEntries(Object.entries(USPS_TO_NAME).map(([k,v])=>[String(v).toLowerCase(),k]));

function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function toNum(v){ const n = Number(v); return isFinite(n) ? n : NaN; }
function normalizePair(D, R){
  const d = Number(D), r = Number(R);
  const s = d + r;
  if (!isFinite(s) || s <= 0) return {D:50, R:50};
  return {D: 100*d/s, R: 100*r/s};
}
function marginRD(pair){ return pair.R - pair.D; } // negative = Dem lead
function fmtLead(m){
  if (!isFinite(m)) return "—";
  if (Math.abs(m) < 0.05) return "Tied";
  const pts = Math.abs(m).toFixed(1);
  return (m < 0) ? `D+${pts}` : `R+${pts}`;
}
function median(arr){
  const a = arr.filter(x=>isFinite(x)).slice().sort((x,y)=>x-y);
  const n = a.length;
  if (!n) return NaN;
  const mid = Math.floor(n/2);
  return (n%2===1) ? a[mid] : 0.5*(a[mid-1] + a[mid]);
}
function interpColor(m){
  if (!isFinite(m)) return "#e5e7eb";
  const max = 25;
  const a = Math.abs(m);
  if (a < 2.0) return "rgb(253,224,71)";
  const t = clamp(a/max, 0, 1);
  if (m < 0){
    const r = Math.round(248*(1-t) + 37*t);
    const g = Math.round(250*(1-t) + 99*t);
    const b = Math.round(252*(1-t) + 235*t);
    return `rgb(${r},${g},${b})`;
  } else {
    const r = Math.round(252*(1-t) + 220*t);
    const g = Math.round(250*(1-t) + 38*t);
    const b = Math.round(250*(1-t) + 38*t);
    return `rgb(${r},${g},${b})`;
  }
}

const WEIGHTS = { gb:35, polls:50, ind:15 };
function computeGenericBallotState(gb, ratio){ return normalizePair(gb.D * ratio.D, gb.R * ratio.R); }
function computePollState(poll){ if (!poll) return null; return normalizePair(poll.D, poll.R); }
function computeIndicatorNat(gb, polls, ratios){
  const implied = [];
  for (const st of Object.keys(polls)){
    const p = computePollState(polls[st]);
    if (!p) continue;
    const r = ratios[st];
    if (!r) continue;
    implied.push({ D: p.D / r.D, R: p.R / r.R });
  }
  if (!implied.length) return null;
  const medD = median(implied.map(x=>x.D));
  const medR = median(implied.map(x=>x.R));
  return normalizePair(medD, medR);
}
function computeIndicatorState(indNat, ratio){ return normalizePair(indNat.D * ratio.D, indNat.R * ratio.R); }
function weightedCombine(components){
  let W=0, D=0, R=0;
  for (const c of components){
    if (!c || !c.pair || !isFinite(c.w) || c.w<=0) continue;
    W += c.w;
    D += c.w * c.pair.D;
    R += c.w * c.pair.R;
  }
  if (W<=0) return normalizePair(50,50);
  return normalizePair(D/W, R/W);
}

async function fetchText(path){
  const r = await fetch(path, {cache:"no-store"});
  if (!r.ok) throw new Error(`HTTP ${r.status} for ${path}`);
  return r.text();
}
async function loadInputs(){
  const errBox = document.getElementById("loadError");
  try {
    const natText = await fetchText("national_polling_averages_2000_2024.csv");
    const bgText  = await fetchText("battleground_polling_summary_2000_2024.csv");

    const natRows = d3.csvParse(natText);
    const rowNat = natRows.find(r => Number(r.Year) === YEAR);
    if (!rowNat) throw new Error(`No national polling row for year=${YEAR}`);
    const gb = normalizePair(toNum(rowNat.Dem_Poll_Avg), toNum(rowNat.GOP_Poll_Avg));

    document.getElementById("natPoll").textContent =
      `D ${gb.D.toFixed(1)}%  •  R ${gb.R.toFixed(1)}%  (${fmtLead(marginRD(gb))})`;
    document.getElementById("natPollMeta").textContent =
      `Source: ${rowNat.Poll_Source || "—"} • Candidates: ${rowNat.Dem_Candidate || "D"} vs ${rowNat.GOP_Candidate || "R"}`;

    const polls = {};
    const bgRows = d3.csvParse(bgText);
    const col = `${YEAR}_Poll_Margin`;
    for (const r of bgRows){
      const nm = String(r.State || "").trim().toLowerCase();
      const st = NAME_TO_USPS[nm];
      if (!st) continue;
      const m = toNum(r[col]);
      if (!isFinite(m)) continue;
      const d = 50 + m/2;
      const rr = 50 - m/2;
      polls[st] = { D: d, R: rr };
    }

    errBox.hidden = true;
    return { gb, polls };
  } catch (e) {
    errBox.hidden = false;
    errBox.innerHTML = `
      <b>Could not load required CSV files.</b><br/>
      Put these in the same folder as this HTML:<br/>
      <span class="mono">national_polling_averages_2000_2024.csv</span><br/>
      <span class="mono">battleground_polling_summary_2000_2024.csv</span><br/>
      Error: <span class="mono">${String(e.message || e)}</span><br/>
      If you opened this as <span class="mono">file://</span>, run a local server (e.g. <span class="mono">python3 -m http.server 8000</span>).
    `;
    throw e;
  }
}

let STATE_GEO = null;
async function loadStateGeo(){
  if (STATE_GEO) return STATE_GEO;
  const topo = await fetch("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json").then(r=>r.json());
  STATE_GEO = topojson.feature(topo, topo.objects.states);
  return STATE_GEO;
}

const tooltip = document.getElementById("tooltip");
function showTip(html, x, y){
  tooltip.innerHTML = html;
  tooltip.style.left = `${x}px`;
  tooltip.style.top = `${y}px`;
  tooltip.style.display = "block";
}
function hideTip(){ tooltip.style.display = "none"; }
function tipHTML(st, model, gbPair, pollPair, indPair){
  const name = USPS_TO_NAME[st] || st;
  const ev = EV[st] ?? 0;
  const m = model ? model.m : NaN;
  const fmtComp = (pair) => pair ? fmtLead(marginRD(pair)) : "—";
  return `
    <div style="font-weight:700; font-size:13px; margin-bottom:6px;">${name} <span style="opacity:.8">(${st})</span></div>
    <div style="display:flex; justify-content:space-between; gap:10px;">
      <div><span style="opacity:.75">EV</span> <b>${ev}</b></div>
      <div><span style="opacity:.75">Forecast</span> <b>${fmtLead(m)}</b></div>
    </div>
    <div style="margin-top:8px; opacity:.85;">
      <div style="display:flex; justify-content:space-between;"><span>GB</span><span class="mono">${fmtComp(gbPair)}</span></div>
      <div style="display:flex; justify-content:space-between;"><span>Poll</span><span class="mono">${fmtComp(pollPair)}</span></div>
      <div style="display:flex; justify-content:space-between;"><span>Ind</span><span class="mono">${fmtComp(indPair)}</span></div>
    </div>
  `;
}

async function renderAll(){
  const { gb, polls } = await loadInputs();
  const indNat = computeIndicatorNat(gb, polls, RATIOS);
  document.getElementById("indNat").textContent = indNat
    ? `D ${indNat.D.toFixed(1)}%  •  R ${indNat.R.toFixed(1)}%  (${fmtLead(marginRD(indNat))})`
    : "—";

  const models = {};
  const gbPairs = {};
  const pollPairs = {};
  const indPairs = {};

  for (const st of Object.keys(RATIOS)){
    const ratio = RATIOS[st];
    const gbPair = computeGenericBallotState(gb, ratio);
    const pollPair = computePollState(polls[st] || null);
    const indPair = indNat ? computeIndicatorState(indNat, ratio) : null;
    const combined = weightedCombine([
      { pair: gbPair,   w: WEIGHTS.gb },
      { pair: pollPair, w: pollPair ? WEIGHTS.polls : 0 },
      { pair: indPair,  w: indPair ? WEIGHTS.ind : 0 },
    ]);
    models[st] = { combined, m: marginRD(combined) };
    gbPairs[st] = gbPair;
    pollPairs[st] = pollPair;
    indPairs[st] = indPair;
  }

  let evD = 0, evR = 0, evToss = 0;
  for (const st of Object.keys(EV)){
    const ev = EV[st] || 0;
    const m = models[st]?.m;
    if (!isFinite(m)) continue;
    if (Math.abs(m) <= 2.0) evToss += ev;
    if (m < 0 || Math.abs(m) < 1e-9) evD += ev; else evR += ev;
  }
  document.getElementById("evTotal").textContent = `D ${evD}  •  R ${evR}`;
  document.getElementById("evMeta").textContent = `Tossup EV (|margin| ≤ 2): ${evToss} • Majority: 270`;

  const rows = Object.keys(EV).map(st => {
    const name = USPS_TO_NAME[st] || st;
    const ev = EV[st] || 0;
    const m = models[st]?.m;
    return {
      st, name, ev, m,
      gb: marginRD(gbPairs[st]),
      poll: pollPairs[st] ? marginRD(pollPairs[st]) : NaN,
      ind: indPairs[st] ? marginRD(indPairs[st]) : NaN
    };
  }).filter(r => isFinite(r.m)).sort((a,b)=>Math.abs(a.m)-Math.abs(b.m));

  const body = document.getElementById("closestBody");
  body.innerHTML = rows.slice(0, 15).map(r => `
    <tr>
      <td>${r.name} <span class="mono" style="opacity:.6;">${r.st}</span></td>
      <td class="right mono">${r.ev}</td>
      <td class="right mono">${fmtLead(r.m)}</td>
      <td class="right mono">${fmtLead(r.gb)}</td>
      <td class="right mono">${isFinite(r.poll) ? fmtLead(r.poll) : "—"}</td>
      <td class="right mono">${isFinite(r.ind) ? fmtLead(r.ind) : "—"}</td>
    </tr>
  `).join("");

  const geo = await loadStateGeo();
  const width = 960, height = 600;
  const svg = d3.select("#map");
  svg.attr("viewBox", `0 0 ${width} ${height}`);
  const projection = d3.geoAlbersUsa();
  projection.fitExtent([[18,18],[width-18,height-18]], geo);
  const pathGen = d3.geoPath(projection);

  svg.selectAll("*").remove();
  svg.append("g")
    .selectAll("path")
    .data(geo.features)
    .join("path")
    .attr("class","state")
    .attr("d", pathGen)
    .attr("data-st", d => FIPS_TO_USPS[Number(d.id)] || "")
    .attr("fill", d => {
      const st = FIPS_TO_USPS[Number(d.id)];
      return interpColor(models[st]?.m);
    })
    .on("mousemove", function(event, d){
      const st = FIPS_TO_USPS[Number(d.id)];
      if (!st) return;
      showTip(tipHTML(st, models[st], gbPairs[st], pollPairs[st], indPairs[st]), event.clientX, event.clientY);
    })
    .on("mouseleave", hideTip);

  window.addEventListener("scroll", hideTip, {passive:true});
}

renderAll().catch(()=>{});
</script>
</body>
</html>
